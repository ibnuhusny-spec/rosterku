<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Input Jadwal SD - Admin</title>
    <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-100 min-h-screen p-4 md:p-8 font-sans text-gray-800">

    <!-- Tombol Navigasi Admin -->
    <div class="max-w-lg mx-auto mb-4 flex justify-between">
        <a href="index.html" class="inline-block bg-gray-200 text-gray-700 hover:bg-gray-300 font-semibold py-2 px-4 rounded-lg transition duration-200 shadow-sm text-sm">
            üè† Ke Halaman Depan
        </a>
        <a href="kelola_data.html" class="inline-block bg-indigo-100 text-indigo-700 hover:bg-indigo-200 font-semibold py-2 px-4 rounded-lg transition duration-200 shadow-sm text-sm">
            ‚öôÔ∏è Kelola Data Master
        </a>
    </div>

    <!-- Form Input Jadwal -->
    <div class="max-w-lg mx-auto bg-white rounded-xl shadow-md overflow-hidden p-6 md:p-8">
        <h2 class="text-2xl font-bold text-center text-blue-600 mb-6">Susun Jadwal Pelajaran (Admin)</h2>
        
        <div id="pesanBox" class="hidden p-4 mb-6 rounded-lg font-medium text-sm"></div>

        <form id="formJadwal" class="space-y-4">
            
            <div>
                <label class="block text-sm font-semibold mb-1">Hari</label>
                <select id="hari" required class="w-full p-2 border border-gray-300 rounded focus:outline-none focus:ring-2 focus:ring-blue-500">
                    <option value="">-- Pilih Hari --</option>
                    <option value="Senin">Senin</option>
                    <option value="Selasa">Selasa</option>
                    <option value="Rabu">Rabu</option>
                    <option value="Kamis">Kamis</option>
                    <option value="Jumat">Jumat</option>
                    <option value="Sabtu">Sabtu</option>
                </select>
            </div>

            <div>
                <label class="block text-sm font-semibold mb-1">Jam Ke-</label>
                <select id="jam_ke" required class="w-full p-2 border border-gray-300 rounded focus:outline-none focus:ring-2 focus:ring-blue-500">
                    <option value="">-- Memuat Jam... --</option>
                </select>
            </div>

            <div>
                <label class="block text-sm font-semibold mb-1">Kelas</label>
                <select id="kelas" required class="w-full p-2 border border-gray-300 rounded focus:outline-none focus:ring-2 focus:ring-blue-500">
                    <option value="">-- Memuat Kelas... --</option>
                </select>
            </div>

            <div>
                <label class="block text-sm font-semibold mb-1">Mata Pelajaran</label>
                <select id="mapel" required class="w-full p-2 border border-gray-300 rounded focus:outline-none focus:ring-2 focus:ring-blue-500">
                    <option value="">-- Memuat Mapel... --</option>
                </select>
            </div>

            <div>
                <label class="block text-sm font-semibold mb-1">Guru Pengajar</label>
                <select id="guru" required class="w-full p-2 border border-gray-300 rounded focus:outline-none focus:ring-2 focus:ring-blue-500">
                    <option value="">-- Memuat Guru... --</option>
                </select>
            </div>

            <button type="submit" id="btnSubmit" class="w-full mt-4 bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-4 rounded transition duration-200">
                Simpan Jadwal
            </button>
        </form>
    </div>

    <!-- TABEL DAFTAR JADWAL UNTUK DIHAPUS (HANYA ADMIN) -->
    <div class="max-w-4xl mx-auto mt-8 mb-10 bg-white rounded-xl shadow-md overflow-hidden p-6 md:p-8">
        <h2 class="text-xl font-bold text-gray-700 mb-4 border-b pb-2">Daftar Jadwal Tersimpan</h2>
        <div class="overflow-x-auto">
            <table class="min-w-full bg-white text-sm">
                <thead class="bg-gray-100 text-gray-600">
                    <tr>
                        <th class="py-2 px-4 text-left font-semibold">Hari</th>
                        <th class="py-2 px-4 text-left font-semibold">Jam</th>
                        <th class="py-2 px-4 text-left font-semibold">Kelas</th>
                        <th class="py-2 px-4 text-left font-semibold">Mapel</th>
                        <th class="py-2 px-4 text-left font-semibold">Guru</th>
                        <th class="py-2 px-4 text-center font-semibold">Aksi</th>
                    </tr>
                </thead>
                <tbody id="tabelAdminJadwal" class="divide-y divide-gray-200">
                    <tr><td colspan="6" class="py-4 text-center text-gray-500">Memuat data...</td></tr>
                </tbody>
            </table>
        </div>
    </div>

    <!-- Script Firebase -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-app.js";
        import { getFirestore, collection, addDoc, query, where, getDocs, onSnapshot, doc, deleteDoc } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-firestore.js";

        // ========================================================
        // ‚ö†Ô∏è MASUKKAN FIREBASE CONFIG ANDA DI SINI
        // ========================================================
        const firebaseConfig = {
             apiKey: "AIzaSyAu8st2VRsNFyzC8UR8TDq8821y4_TVHVk",
  authDomain: "roster-sekolah-sd.firebaseapp.com",
  projectId: "roster-sekolah-sd",
  storageBucket: "roster-sekolah-sd.firebasestorage.app",
  messagingSenderId: "819380185646",
  appId: "1:819380185646:web:39ae854591ca40f0498dbf"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);

        // --- FUNGSI MUAT DROPDOWN MASTER DATA ---
        function muatDropdownMaster(koleksi, idDropdown, teksDefault) {
            const elemen = document.getElementById(idDropdown);
            if (firebaseConfig.apiKey === "API_KEY_ANDA") {
                elemen.innerHTML = `<option value="">-- Menunggu Firebase --</option>`;
                return;
            }
            onSnapshot(collection(db, koleksi), (snapshot) => {
                elemen.innerHTML = `<option value="">-- ${teksDefault} --</option>`;
                snapshot.forEach((doc) => {
                    const data = doc.data();
                    elemen.insertAdjacentHTML('beforeend', `<option value="${data.nama}">${data.nama}</option>`);
                });
            });
        }

        muatDropdownMaster("master_jam", "jam_ke", "Pilih Jam");
        muatDropdownMaster("master_kelas", "kelas", "Pilih Kelas");
        muatDropdownMaster("master_mapel", "mapel", "Pilih Mapel");
        muatDropdownMaster("master_guru", "guru", "Pilih Guru");

        // --- FUNGSI TAMPIL PESAN ---
        const pesanBox = document.getElementById('pesanBox');
        function tampilkanPesan(pesan, tipe) {
            pesanBox.innerHTML = pesan;
            pesanBox.className = `p-4 mb-6 rounded-lg font-medium text-sm block ${tipe === 'sukses' ? 'bg-green-100 text-green-700' : 'bg-red-100 text-red-700'}`;
            pesanBox.classList.remove('hidden');
        }

        // --- FUNGSI TAMPIL & HAPUS JADWAL DI TABEL BAWAH ---
        const tabelAdminJadwal = document.getElementById('tabelAdminJadwal');

        function muatTabelJadwal() {
            if (firebaseConfig.apiKey === "API_KEY_ANDA") {
                 tabelAdminJadwal.innerHTML = `<tr><td colspan="6" class="py-4 text-center text-red-500 font-medium">Firebase belum dikonfigurasi.</td></tr>`;
                 return;
            }
            
            onSnapshot(collection(db, "jadwal_pelajaran"), (snapshot) => {
                tabelAdminJadwal.innerHTML = "";
                if (snapshot.empty) {
                    tabelAdminJadwal.innerHTML = `<tr><td colspan="6" class="py-4 text-center text-gray-500 italic">Belum ada jadwal tersimpan.</td></tr>`;
                    return;
                }

                // Masukkan data ke array untuk disorting (opsional, agar rapi)
                let jadwalArr = [];
                snapshot.forEach(docSnap => {
                    jadwalArr.push({ id: docSnap.id, ...docSnap.data() });
                });

                // Urutkan berdasarkan hari (sederhana) dan jam
                jadwalArr.sort((a, b) => {
                     return a.hari.localeCompare(b.hari) || a.jam_ke.localeCompare(b.jam_ke);
                });

                jadwalArr.forEach(jadwal => {
                    tabelAdminJadwal.insertAdjacentHTML('beforeend', `
                        <tr class="hover:bg-gray-50 transition border-b border-gray-100">
                            <td class="py-3 px-4 text-gray-700">${jadwal.hari}</td>
                            <td class="py-3 px-4 text-gray-700">${jadwal.jam_ke}</td>
                            <td class="py-3 px-4 font-bold text-indigo-700">${jadwal.kelas}</td>
                            <td class="py-3 px-4 text-gray-700">${jadwal.mapel}</td>
                            <td class="py-3 px-4 text-gray-700">${jadwal.guru}</td>
                            <td class="py-3 px-4 text-center">
                                <button onclick="hapusJadwal('${jadwal.id}')" class="bg-red-500 hover:bg-red-600 text-white text-xs font-bold py-1 px-3 rounded shadow-sm transition">
                                    Hapus
                                </button>
                            </td>
                        </tr>
                    `);
                });
            });
        }

        // Jadikan fungsi hapus global agar bisa dipanggil dari atribut onclick di HTML
        window.hapusJadwal = async function(idDokumen) {
            if(confirm("Apakah Anda yakin ingin menghapus jadwal ini?")) {
                try {
                    await deleteDoc(doc(db, "jadwal_pelajaran", idDokumen));
                    // Tidak perlu tampilkanPesan sukses, karena onSnapshot akan merender ulang tabel secara otomatis
                } catch(e) {
                    console.error("Gagal menghapus:", e);
                    alert("Gagal menghapus jadwal. Periksa koneksi internet.");
                }
            }
        };

        muatTabelJadwal();

        // --- FUNGSI SIMPAN JADWAL BARU ---
        const form = document.getElementById('formJadwal');
        const btnSubmit = document.getElementById('btnSubmit');

        form.addEventListener('submit', async (e) => {
            e.preventDefault();

            if (firebaseConfig.apiKey === "API_KEY_ANDA") {
                alert("‚ö†Ô∏è Anda belum memasukkan kode firebaseConfig! Data tidak bisa disimpan.");
                return;
            }

            btnSubmit.innerHTML = "Menyimpan...";
            btnSubmit.disabled = true;
            pesanBox.classList.add('hidden');

            const hari = document.getElementById('hari').value;
            const jam_ke = document.getElementById('jam_ke').value;
            const kelas = document.getElementById('kelas').value;
            const mapel = document.getElementById('mapel').value;
            const guru = document.getElementById('guru').value;

            try {
                const jadwalRef = collection(db, "jadwal_pelajaran");

                // Cek bentrok Guru
                const qGuru = query(jadwalRef, where("hari", "==", hari), where("jam_ke", "==", jam_ke), where("guru", "==", guru));
                const snapshotGuru = await getDocs(qGuru);
                if (!snapshotGuru.empty) {
                    tampilkanPesan(`‚ùå <b>Gagal!</b> ${guru} sudah ada jadwal di hari ${hari} jam ${jam_ke}.`, 'error');
                    btnSubmit.innerHTML = "Simpan Jadwal";
                    btnSubmit.disabled = false;
                    return;
                }

                // Cek bentrok Kelas
                const qKelas = query(jadwalRef, where("hari", "==", hari), where("jam_ke", "==", jam_ke), where("kelas", "==", kelas));
                const snapshotKelas = await getDocs(qKelas);
                if (!snapshotKelas.empty) {
                    tampilkanPesan(`‚ùå <b>Gagal!</b> Kelas ${kelas} sudah ada jadwal di hari ${hari} jam ${jam_ke}.`, 'error');
                    btnSubmit.innerHTML = "Simpan Jadwal";
                    btnSubmit.disabled = false;
                    return;
                }

                // Jika lolos cek, simpan data
                await addDoc(jadwalRef, { hari, jam_ke, kelas, mapel, guru, dibuat_pada: new Date() });
                tampilkanPesan("‚úÖ <b>Sukses!</b> Jadwal berhasil disimpan.", 'sukses');
                form.reset();

            } catch (error) {
                console.error("Error: ", error);
                tampilkanPesan("‚ùå Terjadi kesalahan sistem. Pastikan internet lancar.", 'error');
            }

            btnSubmit.innerHTML = "Simpan Jadwal";
            btnSubmit.disabled = false;
        });
    </script>
</body>
</html>
