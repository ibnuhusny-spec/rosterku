<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Input Jadwal SD - Admin</title>
    <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-100 min-h-screen p-4 md:p-8 font-sans text-gray-800">

    <!-- Tombol Navigasi Admin -->
    <div class="max-w-lg mx-auto mb-4 flex justify-between">
        <a href="index.html" class="inline-block bg-gray-200 text-gray-700 hover:bg-gray-300 font-semibold py-2 px-4 rounded-lg transition duration-200 shadow-sm text-sm">
            üè† Ke Halaman Depan
        </a>
        <a href="kelola_data.html" class="inline-block bg-indigo-100 text-indigo-700 hover:bg-indigo-200 font-semibold py-2 px-4 rounded-lg transition duration-200 shadow-sm text-sm">
            ‚öôÔ∏è Kelola Data Master
        </a>
    </div>

    <div class="max-w-lg mx-auto bg-white rounded-xl shadow-md overflow-hidden p-6 md:p-8">
        <h2 class="text-2xl font-bold text-center text-blue-600 mb-6">Susun Jadwal Pelajaran (Admin)</h2>
        
        <div id="pesanBox" class="hidden p-4 mb-6 rounded-lg font-medium text-sm"></div>

        <form id="formJadwal" class="space-y-4">
            
            <div>
                <label class="block text-sm font-semibold mb-1">Hari</label>
                <select id="hari" required class="w-full p-2 border border-gray-300 rounded focus:outline-none focus:ring-2 focus:ring-blue-500">
                    <option value="">-- Pilih Hari --</option>
                    <option value="Senin">Senin</option>
                    <option value="Selasa">Selasa</option>
                    <option value="Rabu">Rabu</option>
                    <option value="Kamis">Kamis</option>
                    <option value="Jumat">Jumat</option>
                    <option value="Sabtu">Sabtu</option>
                </select>
            </div>

            <!-- Ditarik dari Firebase -->
            <div>
                <label class="block text-sm font-semibold mb-1">Jam Ke-</label>
                <select id="jam_ke" required class="w-full p-2 border border-gray-300 rounded focus:outline-none focus:ring-2 focus:ring-blue-500">
                    <option value="">-- Memuat Jam... --</option>
                </select>
            </div>

            <div>
                <label class="block text-sm font-semibold mb-1">Kelas</label>
                <select id="kelas" required class="w-full p-2 border border-gray-300 rounded focus:outline-none focus:ring-2 focus:ring-blue-500">
                    <option value="">-- Memuat Kelas... --</option>
                </select>
            </div>

            <div>
                <label class="block text-sm font-semibold mb-1">Mata Pelajaran</label>
                <select id="mapel" required class="w-full p-2 border border-gray-300 rounded focus:outline-none focus:ring-2 focus:ring-blue-500">
                    <option value="">-- Memuat Mapel... --</option>
                </select>
            </div>

            <div>
                <label class="block text-sm font-semibold mb-1">Guru Pengajar</label>
                <select id="guru" required class="w-full p-2 border border-gray-300 rounded focus:outline-none focus:ring-2 focus:ring-blue-500">
                    <option value="">-- Memuat Guru... --</option>
                </select>
            </div>

            <button type="submit" id="btnSubmit" class="w-full mt-4 bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-4 rounded transition duration-200">
                Simpan Jadwal
            </button>
        </form>
    </div>

    <!-- Script Firebase versi Modular (v11) -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-app.js";
        import { getFirestore, collection, addDoc, query, where, getDocs, onSnapshot } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-firestore.js";

        // ========================================================
        // ‚ö†Ô∏è MASUKKAN FIREBASE CONFIG ANDA DI SINI
        // ========================================================
        const firebaseConfig = {
             apiKey: "AIzaSyAu8st2VRsNFyzC8UR8TDq8821y4_TVHVk",
  authDomain: "roster-sekolah-sd.firebaseapp.com",
  projectId: "roster-sekolah-sd",
  storageBucket: "roster-sekolah-sd.firebasestorage.app",
  messagingSenderId: "819380185646",
  appId: "1:819380185646:web:39ae854591ca40f0498dbf"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);

        function muatDropdownMaster(koleksi, idDropdown, teksDefault) {
            const elemen = document.getElementById(idDropdown);
            if (firebaseConfig.apiKey === "API_KEY_ANDA") {
                elemen.innerHTML = `<option value="">-- Menunggu Firebase --</option>`;
                return;
            }
            onSnapshot(collection(db, koleksi), (snapshot) => {
                elemen.innerHTML = `<option value="">-- ${teksDefault} --</option>`;
                snapshot.forEach((doc) => {
                    const data = doc.data();
                    elemen.insertAdjacentHTML('beforeend', `<option value="${data.nama}">${data.nama}</option>`);
                });
            });
        }

        muatDropdownMaster("master_jam", "jam_ke", "Pilih Jam");
        muatDropdownMaster("master_kelas", "kelas", "Pilih Kelas");
        muatDropdownMaster("master_mapel", "mapel", "Pilih Mapel");
        muatDropdownMaster("master_guru", "guru", "Pilih Guru");

        const form = document.getElementById('formJadwal');
        const btnSubmit = document.getElementById('btnSubmit');
        const pesanBox = document.getElementById('pesanBox');

        function tampilkanPesan(pesan, tipe) {
            pesanBox.innerHTML = pesan;
            pesanBox.className = `p-4 mb-6 rounded-lg font-medium text-sm block ${tipe === 'sukses' ? 'bg-green-100 text-green-700' : 'bg-red-100 text-red-700'}`;
            pesanBox.classList.remove('hidden');
        }

        form.addEventListener('submit', async (e) => {
            e.preventDefault();

            if (firebaseConfig.apiKey === "API_KEY_ANDA") {
                alert("‚ö†Ô∏è Anda belum memasukkan kode firebaseConfig! Data tidak bisa disimpan.");
                return;
            }

            btnSubmit.innerHTML = "Menyimpan...";
            btnSubmit.disabled = true;
            pesanBox.classList.add('hidden');

            const hari = document.getElementById('hari').value;
            const jam_ke = document.getElementById('jam_ke').value;
            const kelas = document.getElementById('kelas').value;
            const mapel = document.getElementById('mapel').value;
            const guru = document.getElementById('guru').value;

            try {
                const jadwalRef = collection(db, "jadwal_pelajaran");

                const qGuru = query(jadwalRef, where("hari", "==", hari), where("jam_ke", "==", jam_ke), where("guru", "==", guru));
                const snapshotGuru = await getDocs(qGuru);
                if (!snapshotGuru.empty) {
                    tampilkanPesan(`‚ùå <b>Gagal!</b> ${guru} sudah ada jadwal di hari ${hari} jam ${jam_ke}.`, 'error');
                    btnSubmit.innerHTML = "Simpan Jadwal";
                    btnSubmit.disabled = false;
                    return;
                }

                const qKelas = query(jadwalRef, where("hari", "==", hari), where("jam_ke", "==", jam_ke), where("kelas", "==", kelas));
                const snapshotKelas = await getDocs(qKelas);
                if (!snapshotKelas.empty) {
                    tampilkanPesan(`‚ùå <b>Gagal!</b> Kelas ${kelas} sudah ada jadwal di hari ${hari} jam ${jam_ke}.`, 'error');
                    btnSubmit.innerHTML = "Simpan Jadwal";
                    btnSubmit.disabled = false;
                    return;
                }

                await addDoc(jadwalRef, { hari, jam_ke, kelas, mapel, guru, dibuat_pada: new Date() });
                tampilkanPesan("‚úÖ <b>Sukses!</b> Jadwal berhasil disimpan.", 'sukses');
                form.reset();

            } catch (error) {
                console.error("Error: ", error);
                tampilkanPesan("‚ùå Terjadi kesalahan sistem. Pastikan internet lancar.", 'error');
            }

            btnSubmit.innerHTML = "Simpan Jadwal";
            btnSubmit.disabled = false;
        });
    </script>
</body>
</html>
